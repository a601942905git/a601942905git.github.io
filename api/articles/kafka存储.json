{"title":"kafka存储","uid":"9f635fa5cf662529fd1247abdd3830ea","slug":"kafka存储","date":"2022-12-11T05:50:10.000Z","updated":"2022-12-11T05:50:11.338Z","comments":true,"path":"api/articles/kafka存储.json","keywords":null,"cover":[],"content":"<h2 id=\"1-前言\"><a href=\"#1-前言\" class=\"headerlink\" title=\"1.前言\"></a>1.前言</h2><p>系统仅仅拥有高并发、高可用往往是不够的，在此基础上还需要具备高可靠性。那么什么是高可靠性呢？高可靠性就是系统在宕机恢复后数据不丢失，仍然可以保证业务的正常运行。</p>\n<p>作为业务系统的开发人员，提到数据持久化，基于本能反应首选想到的一定是<code>数据库</code>。<code>kafka</code>作为消息中间件，会选择什么方式来进行数据的持久化呢？答案是：<code>日志文件</code></p>\n<h2 id=\"2-日志文件内容\"><a href=\"#2-日志文件内容\" class=\"headerlink\" title=\"2.日志文件内容\"></a>2.日志文件内容</h2><p>既然知道<code>kafka</code>采用日志文件的方式来对数据进行持久化，想你一定会好奇，日志文件中到底存储的是什么内容？</p>\n<h3 id=\"2-1-如何找到日志文件位置\"><a href=\"#2-1-如何找到日志文件位置\" class=\"headerlink\" title=\"2.1 如何找到日志文件位置\"></a>2.1 如何找到日志文件位置</h3><p>想看日志文件内容，首先你得知道日志文件路径，通过<code>config</code>目录下<code>server.properties</code>配置文件中的<code>log.dirs=</code>配置项可以确定日志文件存放路径</p>\n<p>确定配置文件路径后，切换到对应目录，依据<code>topic</code> + <code>partition</code>来确定目标目录，比如想查看<code>topic</code> 为product，<code>0号分区</code>对应的日志文件，需要找到<code>product-0</code> 目录即可</p>\n<p>进入目标目录，查看目录下的文件信息</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">-rw-r--r--  <span class=\"token number\">1</span>   <span class=\"token number\">1137481367</span>        <span class=\"token number\">24</span>  <span class=\"token number\">9</span>  <span class=\"token number\">3</span> <span class=\"token number\">16</span>:02 00000000000000000000.index\n-rw-r--r--  <span class=\"token number\">1</span>   <span class=\"token number\">1137481367</span>     <span class=\"token number\">16375</span>  <span class=\"token number\">9</span>  <span class=\"token number\">3</span> <span class=\"token number\">16</span>:02 00000000000000000000.log\n-rw-r--r--  <span class=\"token number\">1</span>   <span class=\"token number\">1137481367</span>        <span class=\"token number\">48</span>  <span class=\"token number\">9</span>  <span class=\"token number\">3</span> <span class=\"token number\">16</span>:02 00000000000000000000.timeindex\n-rw-r--r--  <span class=\"token number\">1</span>   <span class=\"token number\">1137481367</span>        <span class=\"token number\">24</span>  <span class=\"token number\">9</span>  <span class=\"token number\">3</span> <span class=\"token number\">16</span>:02 00000000000000002186.index\n-rw-r--r--  <span class=\"token number\">1</span>   <span class=\"token number\">1137481367</span>     <span class=\"token number\">16224</span>  <span class=\"token number\">9</span>  <span class=\"token number\">3</span> <span class=\"token number\">16</span>:02 00000000000000002186.log\n-rw-r--r--  <span class=\"token number\">1</span>   <span class=\"token number\">1137481367</span>        <span class=\"token number\">48</span>  <span class=\"token number\">9</span>  <span class=\"token number\">3</span> <span class=\"token number\">16</span>:02 00000000000000002186.timeindex\n-rw-r--r--  <span class=\"token number\">1</span>   <span class=\"token number\">1137481367</span>        <span class=\"token number\">24</span>  <span class=\"token number\">9</span>  <span class=\"token number\">3</span> <span class=\"token number\">16</span>:02 00000000000000004415.index\n-rw-r--r--  <span class=\"token number\">1</span>   <span class=\"token number\">1137481367</span>     <span class=\"token number\">16275</span>  <span class=\"token number\">9</span>  <span class=\"token number\">3</span> <span class=\"token number\">16</span>:02 00000000000000004415.log\n-rw-r--r--  <span class=\"token number\">1</span>   <span class=\"token number\">1137481367</span>        <span class=\"token number\">48</span>  <span class=\"token number\">9</span>  <span class=\"token number\">3</span> <span class=\"token number\">16</span>:02 00000000000000004415.timeindex\n-rw-r--r--  <span class=\"token number\">1</span>   <span class=\"token number\">1137481367</span>        <span class=\"token number\">24</span>  <span class=\"token number\">9</span>  <span class=\"token number\">3</span> <span class=\"token number\">16</span>:02 00000000000000006647.index\n-rw-r--r--  <span class=\"token number\">1</span>   <span class=\"token number\">1137481367</span>     <span class=\"token number\">16278</span>  <span class=\"token number\">9</span>  <span class=\"token number\">3</span> <span class=\"token number\">16</span>:02 00000000000000006647.log\n-rw-r--r--  <span class=\"token number\">1</span>   <span class=\"token number\">1137481367</span>        <span class=\"token number\">48</span>  <span class=\"token number\">9</span>  <span class=\"token number\">3</span> <span class=\"token number\">16</span>:02 00000000000000006647.timeindex\n-rw-r--r--  <span class=\"token number\">1</span>   <span class=\"token number\">1137481367</span>  <span class=\"token number\">10485760</span>  <span class=\"token number\">9</span>  <span class=\"token number\">3</span> <span class=\"token number\">16</span>:02 00000000000000008879.index\n-rw-r--r--  <span class=\"token number\">1</span>   <span class=\"token number\">1137481367</span>      <span class=\"token number\">8594</span>  <span class=\"token number\">9</span>  <span class=\"token number\">3</span> <span class=\"token number\">16</span>:02 00000000000000008879.log\n-rw-r--r--  <span class=\"token number\">1</span>   <span class=\"token number\">1137481367</span>  <span class=\"token number\">10485756</span>  <span class=\"token number\">9</span>  <span class=\"token number\">3</span> <span class=\"token number\">16</span>:02 00000000000000008879.timeindex<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>通过文件信息展示可看出<code>kafka</code>日志中会有三种文件，分别以<code>.index</code>、<code>.log</code>、<code>.timeindex</code>结尾，从名字上可以看出<code>.index</code>、<code>.timeindex</code>应该与索引相关,<code>.log</code>文件才是真正存储数据的地方</p>\n<h3 id=\"2-2-查看日志文件内容\"><a href=\"#2-2-查看日志文件内容\" class=\"headerlink\" title=\"2.2 查看日志文件内容\"></a>2.2 查看日志文件内容</h3><p>明确存储数据文件后，你就可以通过<code>vi</code>命令打开<code>.log</code>文件查看具体内容，不出意外，映入眼帘的是满屏看不懂、不明所以的玩意</p>\n<p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/mq/20220918202500.png\"></p>\n<p>看不懂，那一定是打开的方式不对，千万不要怀疑是自己能力的问题，你可以尝试使用如下方式打开文件</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">bin&#x2F;kafka-run-class.sh kafka.tools.DumpLogSegments --deep-iteration --print-data-log --files &#x2F;xxxxx&#x2F;kafka&#x2F;kafka_2.12-3.2.1&#x2F;logs&#x2F;product-0&#x2F;00000000000000000000.log<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>使用正确方式打开文件内容</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">baseOffset: <span class=\"token number\">0</span> lastOffset: <span class=\"token number\">121</span> count: <span class=\"token number\">122</span> baseSequence: <span class=\"token parameter variable\">-1</span> lastSequence: <span class=\"token parameter variable\">-1</span> producerId: <span class=\"token parameter variable\">-1</span> producerEpoch: <span class=\"token parameter variable\">-1</span> partitionLeaderEpoch: <span class=\"token number\">0</span> isTransactional: <span class=\"token boolean\">false</span> isControl: <span class=\"token boolean\">false</span> deleteHorizonMs: OptionalLong.empty position: <span class=\"token number\">0</span> CreateTime: <span class=\"token number\">1662192149996</span> size: <span class=\"token number\">966</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">3650920144</span> isvalid: <span class=\"token boolean\">true</span>\n<span class=\"token operator\">|</span> offset: <span class=\"token number\">0</span> CreateTime: <span class=\"token number\">1662192149978</span> keySize: <span class=\"token parameter variable\">-1</span> valueSize: <span class=\"token number\">88</span> sequence: <span class=\"token parameter variable\">-1</span> headerKeys: <span class=\"token punctuation\">[</span>__TypeId__<span class=\"token punctuation\">]</span> payload: <span class=\"token string\">\"&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>producerId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>strimzi-canary-client<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>messageId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:1,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>timestamp<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:1662192149651&#125;\"</span>\n<span class=\"token punctuation\">..</span>.\n<span class=\"token operator\">|</span> offset: <span class=\"token number\">121</span> CreateTime: <span class=\"token number\">1662192149996</span> keySize: <span class=\"token parameter variable\">-1</span> valueSize: <span class=\"token number\">90</span> sequence: <span class=\"token parameter variable\">-1</span> headerKeys: <span class=\"token punctuation\">[</span>__TypeId__<span class=\"token punctuation\">]</span> payload: <span class=\"token string\">\"&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>producerId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>strimzi-canary-client<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>messageId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:122,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>timestamp<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:1662192149996&#125;\"</span>\n\n\nbaseOffset: <span class=\"token number\">122</span> lastOffset: <span class=\"token number\">243</span> count: <span class=\"token number\">122</span> baseSequence: <span class=\"token parameter variable\">-1</span> lastSequence: <span class=\"token parameter variable\">-1</span> producerId: <span class=\"token parameter variable\">-1</span> producerEpoch: <span class=\"token parameter variable\">-1</span> partitionLeaderEpoch: <span class=\"token number\">0</span> isTransactional: <span class=\"token boolean\">false</span> isControl: <span class=\"token boolean\">false</span> deleteHorizonMs: OptionalLong.empty position: <span class=\"token number\">966</span> CreateTime: <span class=\"token number\">1662192150002</span> size: <span class=\"token number\">936</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">635681227</span> isvalid: <span class=\"token boolean\">true</span>\n<span class=\"token operator\">|</span> offset: <span class=\"token number\">122</span> CreateTime: <span class=\"token number\">1662192149996</span> keySize: <span class=\"token parameter variable\">-1</span> valueSize: <span class=\"token number\">90</span> sequence: <span class=\"token parameter variable\">-1</span> headerKeys: <span class=\"token punctuation\">[</span>__TypeId__<span class=\"token punctuation\">]</span> payload: <span class=\"token string\">\"&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>producerId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>strimzi-canary-client<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>messageId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:123,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>timestamp<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:1662192149996&#125;\"</span>\n<span class=\"token punctuation\">..</span>.\n<span class=\"token operator\">|</span> offset: <span class=\"token number\">243</span> CreateTime: <span class=\"token number\">1662192150002</span> keySize: <span class=\"token parameter variable\">-1</span> valueSize: <span class=\"token number\">90</span> sequence: <span class=\"token parameter variable\">-1</span> headerKeys: <span class=\"token punctuation\">[</span>__TypeId__<span class=\"token punctuation\">]</span> payload: <span class=\"token string\">\"&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>producerId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>strimzi-canary-client<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>messageId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:244,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>timestamp<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:1662192150002&#125;\"</span>\n\n\nbaseOffset: <span class=\"token number\">244</span> lastOffset: <span class=\"token number\">365</span> count: <span class=\"token number\">122</span> baseSequence: <span class=\"token parameter variable\">-1</span> lastSequence: <span class=\"token parameter variable\">-1</span> producerId: <span class=\"token parameter variable\">-1</span> producerEpoch: <span class=\"token parameter variable\">-1</span> partitionLeaderEpoch: <span class=\"token number\">0</span> isTransactional: <span class=\"token boolean\">false</span> isControl: <span class=\"token boolean\">false</span> deleteHorizonMs: OptionalLong.empty position: <span class=\"token number\">1902</span> CreateTime: <span class=\"token number\">1662192150007</span> size: <span class=\"token number\">905</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">2330978284</span> isvalid: <span class=\"token boolean\">true</span>\n<span class=\"token operator\">|</span> offset: <span class=\"token number\">244</span> CreateTime: <span class=\"token number\">1662192150002</span> keySize: <span class=\"token parameter variable\">-1</span> valueSize: <span class=\"token number\">90</span> sequence: <span class=\"token parameter variable\">-1</span> headerKeys: <span class=\"token punctuation\">[</span>__TypeId__<span class=\"token punctuation\">]</span> payload: <span class=\"token string\">\"&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>producerId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>strimzi-canary-client<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>messageId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:245,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>timestamp<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:1662192150002&#125;\"</span>\n<span class=\"token punctuation\">..</span>.\n<span class=\"token operator\">|</span> offset: <span class=\"token number\">365</span> CreateTime: <span class=\"token number\">1662192150007</span> keySize: <span class=\"token parameter variable\">-1</span> valueSize: <span class=\"token number\">90</span> sequence: <span class=\"token parameter variable\">-1</span> headerKeys: <span class=\"token punctuation\">[</span>__TypeId__<span class=\"token punctuation\">]</span> payload: <span class=\"token string\">\"&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>producerId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>strimzi-canary-client<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>messageId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:366,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>timestamp<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:1662192150007&#125;\"</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>通过内容展示方式可以看到日志文件中记录了每条消息对应的<code>offset</code>、<code>创建时间</code>以及<code>消息内容</code></p>\n<p>再打开<code>00000000000000002186.log</code>查看，可以得出一个结论，那就是文件名对应了该文件中第一条消息的<code>offset</code></p>\n<h2 id=\"3-性能\"><a href=\"#3-性能\" class=\"headerlink\" title=\"3.性能\"></a>3.性能</h2><h3 id=\"3-1-顺序写\"><a href=\"#3-1-顺序写\" class=\"headerlink\" title=\"3.1 顺序写\"></a>3.1 顺序写</h3><p>数据写入磁盘是一种比较耗时操作，以至于看到该类操作的第一反应就是慢，能避免就尽量避免，但是为了保证数据的<code>可靠性</code>，这种操作往往又是不可或缺的</p>\n<p>其实这里往往有一个误区，所有的<code>IO</code>操作都比较慢嘛？当然不是，顺序<code>IO</code>虽没有<code>内存操作</code>快，但是也不差</p>\n<p><code>kafka</code>也是通过采用顺序写<code>IO</code>方式来实现数据写盘，从而提升写性能</p>\n<p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/mq/20220919202100.png\"></p>\n<h3 id=\"3-2-分而治之\"><a href=\"#3-2-分而治之\" class=\"headerlink\" title=\"3.2 分而治之\"></a>3.2 分而治之</h3><p>不知你是否有过类似的经历，打开一个数兆文件只需要几秒时间，但是打开一个数百兆或者更大文件却需要几分钟甚至更长时间</p>\n<p>由此可以想象一下，如果不断往<code>.log</code>文件中追加消息，那么随着时间的推移<code>.log</code>文件会变得越来越大，大到打开该文件需要花费分钟级别的耗时，这对高性能<code>kafka</code>是完全不能接受的一件事情，那么如何解决大文件带来的耗时问题？</p>\n<p><code>分而治之</code>是一种很好的思想，我们可以将一个大文件拆分成由多个小文件组成，从而解决大文件带来的性能问题</p>\n<p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/mq/20220919204700.png\"></p>\n<h3 id=\"3-3-索引查询\"><a href=\"#3-3-索引查询\" class=\"headerlink\" title=\"3.3 索引查询\"></a>3.3 索引查询</h3><p>现在你已经知道<code>kafka</code>会将客户端推送过来的消息存放在<code>.log文件</code>中，那么<code>kafka</code>是如何检索指定<code>offset</code>的消息给消费者进行消费的呢？</p>\n<p>不知你是否会想到前文提到的<code>.index</code>文件，通过如下命令来看看文件中存储的内容</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">bin/kafka-run-class.sh kafka.tools.DumpLogSegments --print-data-log <span class=\"token parameter variable\">--files</span> /xxx/kafka/kafka_2.12-3.2.1/logs/product-0/00000000000000000000.index<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">offset: <span class=\"token number\">731</span> position: <span class=\"token number\">4623</span>\noffset: <span class=\"token number\">1338</span> position: <span class=\"token number\">9121</span>\noffset: <span class=\"token number\">1943</span> position: <span class=\"token number\">13634</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<p>该文件存储了<code>offset</code>与<code>position</code>映射关系，到此可以得出根据<code>offset</code>就能找到对应的<code>position</code>的结论</p>\n<p>看完<code>.index</code>文件后，再来看看主角<code>.log</code>文件</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">baseOffset: <span class=\"token number\">0</span> lastOffset: <span class=\"token number\">121</span> count: <span class=\"token number\">122</span> position: <span class=\"token number\">0</span> CreateTime: <span class=\"token number\">1662192149996</span> size: <span class=\"token number\">966</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">3650920144</span> isvalid: <span class=\"token boolean\">true</span>\n<span class=\"token operator\">|</span> offset: <span class=\"token number\">0</span> CreateTime: <span class=\"token number\">1662192149978</span> keySize: <span class=\"token parameter variable\">-1</span> valueSize: <span class=\"token number\">88</span> sequence: <span class=\"token parameter variable\">-1</span> headerKeys: <span class=\"token punctuation\">[</span>__TypeId__<span class=\"token punctuation\">]</span> payload: <span class=\"token string\">\"&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>producerId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>strimzi-canary-client<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>messageId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:1,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>timestamp<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:1662192149651&#125;\"</span>\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n<span class=\"token operator\">|</span> offset: <span class=\"token number\">121</span> CreateTime: <span class=\"token number\">1662192149996</span> keySize: <span class=\"token parameter variable\">-1</span> valueSize: <span class=\"token number\">90</span> sequence: <span class=\"token parameter variable\">-1</span> headerKeys: <span class=\"token punctuation\">[</span>__TypeId__<span class=\"token punctuation\">]</span> payload: <span class=\"token string\">\"&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>producerId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>strimzi-canary-client<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>messageId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:122,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>timestamp<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:1662192149996&#125;\"</span>\nbaseOffset: <span class=\"token number\">122</span> lastOffset: <span class=\"token number\">243</span> count: <span class=\"token number\">122</span> position: <span class=\"token number\">966</span> CreateTime: <span class=\"token number\">1662192150002</span> size: <span class=\"token number\">936</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">635681227</span> isvalid: <span class=\"token boolean\">true</span>\nbaseOffset: <span class=\"token number\">244</span> lastOffset: <span class=\"token number\">365</span> count: <span class=\"token number\">122</span> position: <span class=\"token number\">1902</span> CreateTime: <span class=\"token number\">1662192150007</span> size: <span class=\"token number\">905</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">2330978284</span> isvalid: <span class=\"token boolean\">true</span>\nbaseOffset: <span class=\"token number\">366</span> lastOffset: <span class=\"token number\">487</span> count: <span class=\"token number\">122</span> position: <span class=\"token number\">2807</span> CreateTime: <span class=\"token number\">1662192150011</span> size: <span class=\"token number\">903</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">1412054061</span> isvalid: <span class=\"token boolean\">true</span>\nbaseOffset: <span class=\"token number\">488</span> lastOffset: <span class=\"token number\">609</span> count: <span class=\"token number\">122</span> position: <span class=\"token number\">3710</span> CreateTime: <span class=\"token number\">1662192150015</span> size: <span class=\"token number\">913</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">3677057634</span> isvalid: <span class=\"token boolean\">true</span>\nbaseOffset: <span class=\"token number\">610</span> lastOffset: <span class=\"token number\">731</span> count: <span class=\"token number\">122</span> position: <span class=\"token number\">4623</span> CreateTime: <span class=\"token number\">1662192150019</span> size: <span class=\"token number\">903</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">1937572371</span> isvalid: <span class=\"token boolean\">true</span>\n<span class=\"token operator\">|</span> offset: <span class=\"token number\">610</span> CreateTime: <span class=\"token number\">1662192150015</span> keySize: <span class=\"token parameter variable\">-1</span> valueSize: <span class=\"token number\">90</span> sequence: <span class=\"token parameter variable\">-1</span> headerKeys: <span class=\"token punctuation\">[</span>__TypeId__<span class=\"token punctuation\">]</span> payload: <span class=\"token string\">\"&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>producerId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>strimzi-canary-client<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>messageId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:611,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>timestamp<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:1662192150015&#125;\"</span>\n<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>\n<span class=\"token operator\">|</span> offset: <span class=\"token number\">731</span> CreateTime: <span class=\"token number\">1662192150019</span> keySize: <span class=\"token parameter variable\">-1</span> valueSize: <span class=\"token number\">90</span> sequence: <span class=\"token parameter variable\">-1</span> headerKeys: <span class=\"token punctuation\">[</span>__TypeId__<span class=\"token punctuation\">]</span> payload: <span class=\"token string\">\"&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>producerId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>strimzi-canary-client<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>messageId<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:732,<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>timestamp<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:1662192150019&#125;\"</span>\n\nbaseOffset: <span class=\"token number\">732</span> lastOffset: <span class=\"token number\">853</span> count: <span class=\"token number\">122</span> position: <span class=\"token number\">5526</span> CreateTime: <span class=\"token number\">1662192150022</span> size: <span class=\"token number\">902</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">677681648</span> isvalid: <span class=\"token boolean\">true</span>\nbaseOffset: <span class=\"token number\">854</span> lastOffset: <span class=\"token number\">975</span> count: <span class=\"token number\">122</span> position: <span class=\"token number\">6428</span> CreateTime: <span class=\"token number\">1662192150025</span> size: <span class=\"token number\">880</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">1374850199</span> isvalid: <span class=\"token boolean\">true</span>\nbaseOffset: <span class=\"token number\">976</span> lastOffset: <span class=\"token number\">1096</span> count: <span class=\"token number\">121</span> position: <span class=\"token number\">7308</span> CreateTime: <span class=\"token number\">1662192150027</span> size: <span class=\"token number\">909</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">2771471302</span> isvalid: <span class=\"token boolean\">true</span>\nbaseOffset: <span class=\"token number\">1097</span> lastOffset: <span class=\"token number\">1217</span> count: <span class=\"token number\">121</span> position: <span class=\"token number\">8217</span> CreateTime: <span class=\"token number\">1662192150030</span> size: <span class=\"token number\">904</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">438650712</span> isvalid: <span class=\"token boolean\">true</span>\nbaseOffset: <span class=\"token number\">1218</span> lastOffset: <span class=\"token number\">1338</span> count: <span class=\"token number\">121</span> position: <span class=\"token number\">9121</span> CreateTime: <span class=\"token number\">1662192150033</span> size: <span class=\"token number\">898</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">983033759</span> isvalid: <span class=\"token boolean\">true</span>\n\nbaseOffset: <span class=\"token number\">1339</span> lastOffset: <span class=\"token number\">1459</span> count: <span class=\"token number\">121</span> position: <span class=\"token number\">10019</span> CreateTime: <span class=\"token number\">1662192150035</span> size: <span class=\"token number\">895</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">964946264</span> isvalid: <span class=\"token boolean\">true</span>\nbaseOffset: <span class=\"token number\">1460</span> lastOffset: <span class=\"token number\">1580</span> count: <span class=\"token number\">121</span> position: <span class=\"token number\">10914</span> CreateTime: <span class=\"token number\">1662192150040</span> size: <span class=\"token number\">941</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">2189697033</span> isvalid: <span class=\"token boolean\">true</span>\nbaseOffset: <span class=\"token number\">1581</span> lastOffset: <span class=\"token number\">1701</span> count: <span class=\"token number\">121</span> position: <span class=\"token number\">11855</span> CreateTime: <span class=\"token number\">1662192150043</span> size: <span class=\"token number\">903</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">2220582279</span> isvalid: <span class=\"token boolean\">true</span>\nbaseOffset: <span class=\"token number\">1702</span> lastOffset: <span class=\"token number\">1822</span> count: <span class=\"token number\">121</span> position: <span class=\"token number\">12758</span> CreateTime: <span class=\"token number\">1662192150045</span> size: <span class=\"token number\">876</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">3714367387</span> isvalid: <span class=\"token boolean\">true</span>\nbaseOffset: <span class=\"token number\">1823</span> lastOffset: <span class=\"token number\">1943</span> count: <span class=\"token number\">121</span> position: <span class=\"token number\">13634</span> CreateTime: <span class=\"token number\">1662192150048</span> size: <span class=\"token number\">901</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">531545191</span> isvalid: <span class=\"token boolean\">true</span>\n\nbaseOffset: <span class=\"token number\">1944</span> lastOffset: <span class=\"token number\">2064</span> count: <span class=\"token number\">121</span> position: <span class=\"token number\">14535</span> CreateTime: <span class=\"token number\">1662192150050</span> size: <span class=\"token number\">896</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">3782783873</span> isvalid: <span class=\"token boolean\">true</span>\nbaseOffset: <span class=\"token number\">2065</span> lastOffset: <span class=\"token number\">2185</span> count: <span class=\"token number\">121</span> position: <span class=\"token number\">15431</span> CreateTime: <span class=\"token number\">1662192150055</span> size: <span class=\"token number\">944</span> magic: <span class=\"token number\">2</span> compresscodec: <span class=\"token function\">gzip</span> crc: <span class=\"token number\">198975981</span> isvalid: <span class=\"token boolean\">true</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p>根据<code>.log</code>文件内容，可以画出下图</p>\n<p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/mq/20220923212000.png\">结论：</p>\n<p>1.根据指定的<code>offset</code>在<code>.index</code>文件中找到对应的<code>position</code></p>\n<p>2.根据<code>position</code>在<code>.log</code>文件中找到目标位置，如果查找目标<code>offset</code>大于<code>position</code>对应的<code>offset</code>，那么向后查找，否则向前查找，直到找到目标<code>offset</code>对应消息为止</p>\n<h2 id=\"4-总结\"><a href=\"#4-总结\" class=\"headerlink\" title=\"4.总结\"></a>4.总结</h2><p>在了解完<code>kafka</code>消息存放形式以及查找方式后，我们能从中学到哪些内容呢？</p>\n<p>1.针对大文件带来的读写问题，可以通过<code>拆分</code>文件的方式进行解决，类比<code>elasticsearch</code>以及<code>redis</code>分片，分而治之思想</p>\n<p>2.针对查询慢的问题，可以通过创建索引方式进行解决，类比<code>mysql</code>索引、<code>书本</code>目录</p>\n","text":"1.前言系统仅仅拥有高并发、高可用往往是不够的，在此基础上还需要具备高可靠性。那么什么是高可靠性呢？高可靠性就是系统在宕机恢复后数据不丢失，仍然可以保证业务的正常运行。 作为业务系统的开发人员，提到数据持久化，基于本能反应首选想到的一定是数据库。kafka作为消息中间件，会选择什...","link":"","photos":[],"count_time":{"symbolsCount":"9.1k","symbolsTime":"8 mins."},"categories":[{"name":"消息中间件","slug":"消息中间件","count":6,"path":"api/categories/消息中间件.json"}],"tags":[{"name":"kafka","slug":"kafka","count":4,"path":"api/tags/kafka.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1-%E5%89%8D%E8%A8%80\"><span class=\"toc-text\">1.前言</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#2-%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9\"><span class=\"toc-text\">2.日志文件内容</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-1-%E5%A6%82%E4%BD%95%E6%89%BE%E5%88%B0%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E4%BD%8D%E7%BD%AE\"><span class=\"toc-text\">2.1 如何找到日志文件位置</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-2-%E6%9F%A5%E7%9C%8B%E6%97%A5%E5%BF%97%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9\"><span class=\"toc-text\">2.2 查看日志文件内容</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#3-%E6%80%A7%E8%83%BD\"><span class=\"toc-text\">3.性能</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-1-%E9%A1%BA%E5%BA%8F%E5%86%99\"><span class=\"toc-text\">3.1 顺序写</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-2-%E5%88%86%E8%80%8C%E6%B2%BB%E4%B9%8B\"><span class=\"toc-text\">3.2 分而治之</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-3-%E7%B4%A2%E5%BC%95%E6%9F%A5%E8%AF%A2\"><span class=\"toc-text\">3.3 索引查询</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#4-%E6%80%BB%E7%BB%93\"><span class=\"toc-text\">4.总结</span></a></li></ol>","author":{"name":"黑白搬砖工","slug":"blog-author","avatar":"https://wolf-heart.oss-cn-beijing.aliyuncs.com/lg_22641_1606122876_5fbb7d7c432a1.jpeg","link":"/","description":"一位正在重塑知识的技术人","socials":{"github":"https://github.com/a601942905git","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/483440845930343","customs":{}}},"mapped":true,"prev_post":{"title":"动态伸缩你的服务","uid":"a74d032dc9bf8ca9d012adc342b4fd84","slug":"动态伸缩你的服务","date":"2022-12-10T13:57:00.000Z","updated":"2022-12-10T14:01:06.650Z","comments":true,"path":"api/articles/动态伸缩你的服务.json","keywords":null,"cover":[],"text":"1.前言如你所知，服务的常规部署方式如下： 对外暴露的服务都会在前面部署nginx用于提供反向代理和负载均衡能力 下面会快速部署一套类似的服务，分析其存在的问题并给出相应解决方案 2.应用相关2.1 启动服务使用boot-cloud-openfeign-provider启动3个服...","link":"","photos":[],"count_time":{"symbolsCount":"3k","symbolsTime":"3 mins."},"categories":[{"name":"微服务","slug":"微服务","count":3,"path":"api/categories/微服务.json"}],"tags":[{"name":"consul","slug":"consul","count":1,"path":"api/tags/consul.json"},{"name":"nginx","slug":"nginx","count":1,"path":"api/tags/nginx.json"},{"name":"consul-template","slug":"consul-template","count":1,"path":"api/tags/consul-template.json"}],"author":{"name":"黑白搬砖工","slug":"blog-author","avatar":"https://wolf-heart.oss-cn-beijing.aliyuncs.com/lg_22641_1606122876_5fbb7d7c432a1.jpeg","link":"/","description":"一位正在重塑知识的技术人","socials":{"github":"https://github.com/a601942905git","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/483440845930343","customs":{}}},"feature":true},"next_post":{"title":"带你看懂redis IO模型","uid":"5ce0c663a19d8e8ee699635ec101be20","slug":"IO模型","date":"2022-12-11T05:49:28.000Z","updated":"2022-12-11T05:53:54.916Z","comments":true,"path":"api/articles/IO模型.json","keywords":null,"cover":[],"text":"1.前言如你所知，高性能web服务器Nginx选择使用IO多路复用技术处理客户端请求，高性能内存数据库Redis同样也选择使用IO多路复用技术处理客户端请求，这足以说明IO多路复用是非常优秀的IO模型，毕竟人以类聚、物以群分。 接下来会从传统阻塞IO模型说起，聊到传统非阻塞IO模...","link":"","photos":[],"count_time":{"symbolsCount":"1.7k","symbolsTime":"2 mins."},"categories":[{"name":"redis","slug":"redis","count":1,"path":"api/categories/redis.json"}],"tags":[{"name":"多路复用","slug":"多路复用","count":1,"path":"api/tags/多路复用.json"}],"author":{"name":"黑白搬砖工","slug":"blog-author","avatar":"https://wolf-heart.oss-cn-beijing.aliyuncs.com/lg_22641_1606122876_5fbb7d7c432a1.jpeg","link":"/","description":"一位正在重塑知识的技术人","socials":{"github":"https://github.com/a601942905git","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/483440845930343","customs":{}}}}}