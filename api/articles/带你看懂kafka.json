{"title":"带你看懂kafka","uid":"4d529d29bdaac9a514904201dfd2325c","slug":"带你看懂kafka","date":"2022-12-11T05:51:06.000Z","updated":"2022-12-11T05:50:57.228Z","comments":true,"path":"api/articles/带你看懂kafka.json","keywords":null,"cover":[],"content":"<h2 id=\"1-前言\"><a href=\"#1-前言\" class=\"headerlink\" title=\"1.前言\"></a>1.前言</h2><p><code>kafka</code>服务端存在相当多的术语，只有了解这些术语具体的含义，我们才能对<code>kafka</code>有一个粗略的认识。本文将带着你去了解以及理清相关术语，让你不再对其感到陌生以及恐惧。</p>\n<h2 id=\"2-集群搭建\"><a href=\"#2-集群搭建\" class=\"headerlink\" title=\"2.集群搭建\"></a>2.集群搭建</h2><p><code>工欲善其事必先利其器</code>，在正式开始前，我们需要搭建一个<code>kafka集群</code></p>\n<p>集群搭建选择使用<code>docker-compose</code>方式，使用该方式的好处就是：在<code>docker-compose.yml</code>文件编写完成的情况下，只需要一条命令即可实现集群的<code>运行</code>与<code>停止</code></p>\n<h3 id=\"2-1-编写docker-compose-yml\"><a href=\"#2-1-编写docker-compose-yml\" class=\"headerlink\" title=\"2.1 编写docker-compose.yml\"></a>2.1 编写docker-compose.yml</h3><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3\"</span>\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">zookeeper</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'zookeeper:latest'</span>\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'2181:2181'</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ALLOW_ANONYMOUS_LOGIN=yes\n  <span class=\"token key atrule\">kafka0</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'bitnami/kafka:latest'</span>\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'9092:9092'</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> KAFKA_BROKER_ID=0\n      <span class=\"token punctuation\">-</span> KAFKA_CFG_LISTENERS=PLAINTEXT<span class=\"token punctuation\">:</span>//0.0.0.0<span class=\"token punctuation\">:</span><span class=\"token number\">9092</span>\n      <span class=\"token punctuation\">-</span> KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT<span class=\"token punctuation\">:</span>//192.168.0.101<span class=\"token punctuation\">:</span><span class=\"token number\">9092</span>\n      <span class=\"token punctuation\">-</span> KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper<span class=\"token punctuation\">:</span><span class=\"token number\">2181</span>\n      <span class=\"token punctuation\">-</span> ALLOW_PLAINTEXT_LISTENER=yes\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 宿主机日志目录<span class=\"token punctuation\">:</span>/bitnami/kafka\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> zookeeper\n  <span class=\"token key atrule\">kafka1</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'bitnami/kafka:latest'</span>\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'9093:9093'</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> KAFKA_BROKER_ID=1\n      <span class=\"token punctuation\">-</span> KAFKA_CFG_LISTENERS=PLAINTEXT<span class=\"token punctuation\">:</span>//0.0.0.0<span class=\"token punctuation\">:</span><span class=\"token number\">9093</span>\n      <span class=\"token punctuation\">-</span> KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT<span class=\"token punctuation\">:</span>//192.168.0.101<span class=\"token punctuation\">:</span><span class=\"token number\">9093</span>\n      <span class=\"token punctuation\">-</span> KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper<span class=\"token punctuation\">:</span><span class=\"token number\">2181</span>\n      <span class=\"token punctuation\">-</span> ALLOW_PLAINTEXT_LISTENER=yes\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 宿主机日志目录<span class=\"token punctuation\">:</span>/bitnami/kafka\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> zookeeper\n  <span class=\"token key atrule\">kafka2</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'bitnami/kafka:latest'</span>\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">'9094:9094'</span>\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> KAFKA_BROKER_ID=2\n      <span class=\"token punctuation\">-</span> KAFKA_CFG_LISTENERS=PLAINTEXT<span class=\"token punctuation\">:</span>//0.0.0.0<span class=\"token punctuation\">:</span><span class=\"token number\">9094</span>\n      <span class=\"token punctuation\">-</span> KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT<span class=\"token punctuation\">:</span>//192.168.0.101<span class=\"token punctuation\">:</span><span class=\"token number\">9094</span>\n      <span class=\"token punctuation\">-</span> KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper<span class=\"token punctuation\">:</span><span class=\"token number\">2181</span>\n      <span class=\"token punctuation\">-</span> ALLOW_PLAINTEXT_LISTENER=yes\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 宿主机日志目录<span class=\"token punctuation\">:</span>/bitnami/kafka\n    <span class=\"token key atrule\">depends_on</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> zookeeper<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>注意：如果希望通过宿主机连接kafka集群，需要添加<code>KAFKA_CFG_LISTENERS</code>和<code>KAFKA_CFG_ADVERTISED_LISTENERS</code>配置并且<code>KAFKA_CFG_ADVERTISED_LISTENERS</code>配置地址为宿主机对应ip</p>\n<p><code>KAFKA_CFG_ADVERTISED_LISTENERS</code>为暴露给客户端的监听地址</p></blockquote>\n<h3 id=\"2-2-运行集群\"><a href=\"#2-2-运行集群\" class=\"headerlink\" title=\"2.2 运行集群\"></a>2.2 运行集群</h3><p>在编写完<code>docker-compose.yml</code>文件后，只需下面的一条命令即可完成集群的运行</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">docker-compose</span> up <span class=\"token parameter variable\">-d</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p>集群运行正常，你将看到如下内容输出</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">Creating network <span class=\"token string\">\"kafka_default\"</span> with the default driver\nCreating kafka_zookeeper_1 <span class=\"token punctuation\">..</span>. <span class=\"token keyword\">done</span>\nCreating kafka_kafka0_1    <span class=\"token punctuation\">..</span>. <span class=\"token keyword\">done</span>\nCreating kafka_kafka2_1    <span class=\"token punctuation\">..</span>. <span class=\"token keyword\">done</span>\nCreating kafka_kafka1_1    <span class=\"token punctuation\">..</span>. <span class=\"token keyword\">done</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"2-3-停止集群\"><a href=\"#2-3-停止集群\" class=\"headerlink\" title=\"2.3 停止集群\"></a>2.3 停止集群</h3><p>如果你想停止集群，那么同样可以使用一条命令来实现</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">docker-compose</span> down<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h2 id=\"3-概念\"><a href=\"#3-概念\" class=\"headerlink\" title=\"3.概念\"></a>3.概念</h2><h3 id=\"3-1-主题\"><a href=\"#3-1-主题\" class=\"headerlink\" title=\"3.1 主题\"></a>3.1 主题</h3><p><code>主题(topic)</code>作为一个逻辑概念，在系统中主要用于区分业务场景，比如可以为下单场景创建一个topic：<code>create-order</code>，为加入购物车场景创建一个topic：<code>add-cart</code></p>\n<h4 id=\"3-1-1-创建主题\"><a href=\"#3-1-1-创建主题\" class=\"headerlink\" title=\"3.1.1 创建主题\"></a>3.1.1 创建主题</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">bin/kafka-topics.sh <span class=\"token parameter variable\">--create</span> <span class=\"token parameter variable\">--topic</span> create-order --bootstrap-server <span class=\"token number\">127.0</span>.0.1:9092 <span class=\"token parameter variable\">--partitions</span> <span class=\"token number\">3</span> --replication-factor <span class=\"token number\">3</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>–partitions：用于指定主题对应分区数量</p>\n<p>–replication-factor：用于指定分区对应副本数量</p></blockquote>\n<h4 id=\"3-1-2-查看主题信息\"><a href=\"#3-1-2-查看主题信息\" class=\"headerlink\" title=\"3.1.2 查看主题信息\"></a>3.1.2 查看主题信息</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">bin/kafka-topics.sh <span class=\"token parameter variable\">--describe</span> <span class=\"token parameter variable\">--topic</span> create-order --bootstrap-server localhost:9092<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/mq/20221113171100.png\"></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>通过如上命令可以查看主题详细信息，包括：分区数量、分区leader、分区副本数、AR以及ISR</p></blockquote>\n<h3 id=\"3-2-分区\"><a href=\"#3-2-分区\" class=\"headerlink\" title=\"3.2 分区\"></a>3.2 分区</h3><p>在<code>3.1</code>创建主题部分我们通过<code>--partitions</code>参数指定了主题对应分区数</p>\n<p><code>分区</code>作为一个物理概念，分散在各个<code>broker</code>中，可以提升并发能力以及服务性能</p>\n<p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/mq/20221113172300.png\"></p>\n<h3 id=\"3-3-副本\"><a href=\"#3-3-副本\" class=\"headerlink\" title=\"3.3 副本\"></a>3.3 副本</h3><p><code>副本</code>的存在是为了提升<code>分区</code>数据可靠性，副本分为<code>leader</code>副本和<code>flower</code>副本，<code>leader</code>副本负责处理客户端的<code>读写请求</code>，<code>flower</code>副本只负责从<code>leader</code>副本同步数据</p>\n<p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/mq/20221113173400.png\"></p>\n<h3 id=\"3-4-AR\"><a href=\"#3-4-AR\" class=\"headerlink\" title=\"3.4 AR\"></a>3.4 AR</h3><p><code>AR(Assigned Replicas)</code>：分区所有副本集合</p>\n<p><code>topic</code>：create-order，<code>partition0</code>对应AR：1，2，0</p>\n<p><code>topic</code>：create-order，<code>partition1</code>对应AR：0，1，2</p>\n<p><code>topic</code>：create-order，<code>partition2</code>对应AR：2，0，1</p>\n<h3 id=\"3-5-ISR\"><a href=\"#3-5-ISR\" class=\"headerlink\" title=\"3.5 ISR\"></a>3.5 ISR</h3><p><code>ISR(In-Sync Replicas)</code>：保持正常同步的副本集合(包含<code>leader</code>副本)</p>\n<p><code>topic</code>：create-order，<code>partition0</code>对应ISR：1，2，0</p>\n<p><code>topic</code>：create-order，<code>partition1</code>对应ISR：0，1，2</p>\n<p><code>topic</code>：create-order，<code>partition2</code>对应ISR：2，0，1</p>\n<h3 id=\"3-6-OSR\"><a href=\"#3-6-OSR\" class=\"headerlink\" title=\"3.6 OSR\"></a>3.6 OSR</h3><p><code>OSR(Out-Of-Sync Replicas)</code>：与<code>leader</code>副本同步滞后过多的<code>flower</code>副本集合</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>当OSR为空时，AR &#x3D; ISR，否则，AR &#x3D; ISR + OSR</p></blockquote>\n<h3 id=\"3-7-LE0\"><a href=\"#3-7-LE0\" class=\"headerlink\" title=\"3.7 LE0\"></a>3.7 LE0</h3><p><code>LEO(Log End Offset)</code>：分区待写入消息对应偏移量</p>\n<p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/mq/20221113200300.png\"></p>\n<h3 id=\"3-8-HW\"><a href=\"#3-8-HW\" class=\"headerlink\" title=\"3.8 HW\"></a>3.8 HW</h3><p><code>HW(High Water)</code>：分区所有副本都会维护自己的<code>LEO</code>，副本中最小的<code>LEO</code>即为<code>HW</code></p>\n<p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/mq/20221113201200.png\"></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>注意：消费者只能拉取到<code>HW</code>之前的消息进行消费</p></blockquote>\n<h3 id=\"3-9-Controller\"><a href=\"#3-9-Controller\" class=\"headerlink\" title=\"3.9 Controller\"></a>3.9 Controller</h3><p><code>Controller</code>：集群协调器，负责</p>\n<ul>\n<li>创建、删除主题，增加分区并分配leader分区；</li>\n<li>集群Broker管理（新增 Broker、Broker 主动关闭、Broker 故障)</li>\n<li><strong>preferred leader</strong>选举</li>\n<li>分区重分配</li>\n</ul>\n<p>从<code>Controller</code>作用可以看到其重要性，那么<code>Controller</code>是如何选举出来的呢？</p>\n<p>在<code>集群</code>启动的过程中，节点会在<code>zookeeper</code>中创建<code>controller</code>节点，谁先创建成功谁就是<code>Controller</code></p>\n<p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/mq/20221113202800.png\"></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>通过重启集群，可以看到<code>controller</code>节点下<code>brokerid</code>对应的值也在变化</p></blockquote>\n<p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/mq/20221113204100.png\"></p>\n<h3 id=\"3-10-leader选举\"><a href=\"#3-10-leader选举\" class=\"headerlink\" title=\"3.10 leader选举\"></a>3.10 leader选举</h3><p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/mq/20221114145500.png\"></p>\n<p><code>topic</code>：<code>create-order</code>，<code>partition</code>：<code>0</code>在未停掉brokerid:2的情况下，分区<code>leader</code>分配在<code>brokerid</code>为<code>2</code>的机器上</p>\n<p><code>topic</code>：<code>create-order</code>，<code>partition</code>：<code>0</code>在停掉brokerid:2的情况下，分区<code>leader</code>分配在<code>brokerid</code>为<code>1</code>的机器上</p>\n<p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/mq/20221114191400.png\"></p>\n<p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/mq/20221114191500.png\"></p>\n<p><code>topic</code>：<code>create-order</code>，<code>partition</code>：<code>1</code>在未停掉brokerid:0的情况下，分区<code>leader</code>分配在<code>brokerid</code>为<code>0</code>的机器上</p>\n<p><code>topic</code>：<code>create-order</code>，<code>partition</code>：<code>1</code>在停掉brokerid:0的情况下，分区<code>leader</code>分配在<code>brokerid</code>为<code>2</code>的机器上</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>由此可见，分区的<code>leader</code>的选举首选要保证在<code>Isr</code>列表中，按照<code>Replicas</code>列表的顺序选举</p></blockquote>\n<h2 id=\"4-zookeeper中存储的信息\"><a href=\"#4-zookeeper中存储的信息\" class=\"headerlink\" title=\"4.zookeeper中存储的信息\"></a>4.zookeeper中存储的信息</h2><p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/mq/20221114195700.png\"></p>\n","feature":true,"text":"1.前言kafka服务端存在相当多的术语，只有了解这些术语具体的含义，我们才能对kafka有一个粗略的认识。本文将带着你去了解以及理清相关术语，让你不再对其感到陌生以及恐惧。 2.集群搭建工欲善其事必先利其器，在正式开始前，我们需要搭建一个kafka集群 集群搭建选择使用dock...","link":"","photos":[],"count_time":{"symbolsCount":"4k","symbolsTime":"4 mins."},"categories":[{"name":"消息中间件","slug":"消息中间件","count":6,"path":"api/categories/消息中间件.json"}],"tags":[{"name":"kafka","slug":"kafka","count":4,"path":"api/tags/kafka.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1-%E5%89%8D%E8%A8%80\"><span class=\"toc-text\">1.前言</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#2-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA\"><span class=\"toc-text\">2.集群搭建</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-1-%E7%BC%96%E5%86%99docker-compose-yml\"><span class=\"toc-text\">2.1 编写docker-compose.yml</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-2-%E8%BF%90%E8%A1%8C%E9%9B%86%E7%BE%A4\"><span class=\"toc-text\">2.2 运行集群</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-3-%E5%81%9C%E6%AD%A2%E9%9B%86%E7%BE%A4\"><span class=\"toc-text\">2.3 停止集群</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#3-%E6%A6%82%E5%BF%B5\"><span class=\"toc-text\">3.概念</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-1-%E4%B8%BB%E9%A2%98\"><span class=\"toc-text\">3.1 主题</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3-1-1-%E5%88%9B%E5%BB%BA%E4%B8%BB%E9%A2%98\"><span class=\"toc-text\">3.1.1 创建主题</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3-1-2-%E6%9F%A5%E7%9C%8B%E4%B8%BB%E9%A2%98%E4%BF%A1%E6%81%AF\"><span class=\"toc-text\">3.1.2 查看主题信息</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-2-%E5%88%86%E5%8C%BA\"><span class=\"toc-text\">3.2 分区</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-3-%E5%89%AF%E6%9C%AC\"><span class=\"toc-text\">3.3 副本</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-4-AR\"><span class=\"toc-text\">3.4 AR</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-5-ISR\"><span class=\"toc-text\">3.5 ISR</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-6-OSR\"><span class=\"toc-text\">3.6 OSR</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-7-LE0\"><span class=\"toc-text\">3.7 LE0</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-8-HW\"><span class=\"toc-text\">3.8 HW</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-9-Controller\"><span class=\"toc-text\">3.9 Controller</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-10-leader%E9%80%89%E4%B8%BE\"><span class=\"toc-text\">3.10 leader选举</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#4-zookeeper%E4%B8%AD%E5%AD%98%E5%82%A8%E7%9A%84%E4%BF%A1%E6%81%AF\"><span class=\"toc-text\">4.zookeeper中存储的信息</span></a></li></ol>","author":{"name":"黑白搬砖工","slug":"blog-author","avatar":"https://wolf-heart.oss-cn-beijing.aliyuncs.com/lg_22641_1606122876_5fbb7d7c432a1.jpeg","link":"/","description":"一位正在重塑知识的技术人","socials":{"github":"https://github.com/a601942905git","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/483440845930343","customs":{}}},"mapped":true,"prev_post":{"title":"带你看懂rabbitmq集群","uid":"6c37772ad206371cddc6299a58095fb8","slug":"带你看懂rabbitmq集群","date":"2022-12-11T05:52:18.000Z","updated":"2022-12-11T05:52:49.825Z","comments":true,"path":"api/articles/带你看懂rabbitmq集群.json","keywords":null,"cover":[],"text":"1. 如何实现rabbitmq高可用服务高可用实现准则服务尽可能少中断、数据尽可能少丢，因此为了达到这一目标，可以通过集群部署来实现 2. rabbitmq集群搭建完成，队列数据是否就高可用了？2.1 官方描述 By default, contents of a queue wi...","link":"","photos":[],"count_time":{"symbolsCount":"7.2k","symbolsTime":"7 mins."},"categories":[{"name":"消息中间件","slug":"消息中间件","count":6,"path":"api/categories/消息中间件.json"}],"tags":[{"name":"rabbit","slug":"rabbit","count":1,"path":"api/tags/rabbit.json"}],"author":{"name":"黑白搬砖工","slug":"blog-author","avatar":"https://wolf-heart.oss-cn-beijing.aliyuncs.com/lg_22641_1606122876_5fbb7d7c432a1.jpeg","link":"/","description":"一位正在重塑知识的技术人","socials":{"github":"https://github.com/a601942905git","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/483440845930343","customs":{}}},"feature":true},"next_post":{"title":"动态伸缩你的服务","uid":"a74d032dc9bf8ca9d012adc342b4fd84","slug":"动态伸缩你的服务","date":"2022-12-10T13:57:00.000Z","updated":"2022-12-10T14:01:06.650Z","comments":true,"path":"api/articles/动态伸缩你的服务.json","keywords":null,"cover":[],"text":"1.前言如你所知，服务的常规部署方式如下： 对外暴露的服务都会在前面部署nginx用于提供反向代理和负载均衡能力 下面会快速部署一套类似的服务，分析其存在的问题并给出相应解决方案 2.应用相关2.1 启动服务使用boot-cloud-openfeign-provider启动3个服...","link":"","photos":[],"count_time":{"symbolsCount":"3k","symbolsTime":"3 mins."},"categories":[{"name":"微服务","slug":"微服务","count":3,"path":"api/categories/微服务.json"}],"tags":[{"name":"consul","slug":"consul","count":1,"path":"api/tags/consul.json"},{"name":"nginx","slug":"nginx","count":1,"path":"api/tags/nginx.json"},{"name":"consul-template","slug":"consul-template","count":1,"path":"api/tags/consul-template.json"}],"author":{"name":"黑白搬砖工","slug":"blog-author","avatar":"https://wolf-heart.oss-cn-beijing.aliyuncs.com/lg_22641_1606122876_5fbb7d7c432a1.jpeg","link":"/","description":"一位正在重塑知识的技术人","socials":{"github":"https://github.com/a601942905git","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/483440845930343","customs":{}}},"feature":true}}