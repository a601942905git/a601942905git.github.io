{"title":"动态伸缩你的服务","uid":"a74d032dc9bf8ca9d012adc342b4fd84","slug":"动态伸缩你的服务","date":"2022-12-10T13:57:00.000Z","updated":"2022-12-10T14:01:06.650Z","comments":true,"path":"api/articles/动态伸缩你的服务.json","keywords":null,"cover":[],"content":"<h2 id=\"1-前言\"><a href=\"#1-前言\" class=\"headerlink\" title=\"1.前言\"></a>1.前言</h2><p>如你所知，服务的常规部署方式如下：</p>\n<p><img src=\"https://wolf-heart.oss-cn-beijing.aliyuncs.com/blog/consul/1640597677582.jpg\"></p>\n<p>对外暴露的服务都会在前面部署<code>nginx</code>用于提供<code>反向代理</code>和<code>负载均衡</code>能力</p>\n<p>下面会快速部署一套类似的服务，分析其存在的问题并给出相应解决方案</p>\n<h2 id=\"2-应用相关\"><a href=\"#2-应用相关\" class=\"headerlink\" title=\"2.应用相关\"></a>2.应用相关</h2><h3 id=\"2-1-启动服务\"><a href=\"#2-1-启动服务\" class=\"headerlink\" title=\"2.1 启动服务\"></a>2.1 启动服务</h3><p>使用<a href=\"https://github.com/a601942905git/boot-cloud/tree/master/boot-cloud-spring/boot-cloud-openfeign/boot-cloud-openfeign-provider\">boot-cloud-openfeign-provider</a>启动3个服务实例，端口分别为8081、8082、8083</p>\n<h3 id=\"2-2-服务验证\"><a href=\"#2-2-服务验证\" class=\"headerlink\" title=\"2.2 服务验证\"></a>2.2 服务验证</h3><p>在浏览器中分别输入：<a href=\"http://localhost:8081/index/nginx%E3%80%81http://localhost:8082/index/nginx%E3%80%81http://localhost:8083/index/nginx%EF%BC%8C%E4%BF%9D%E8%AF%813%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%AE%9E%E4%BE%8B%E5%9D%87%E5%8F%AF%E8%A2%AB%E8%AE%BF%E9%97%AE\">http://localhost:8081/index/nginx、http://localhost:8082/index/nginx、http://localhost:8083/index/nginx，保证3个服务实例均可被访问</a></p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>服务运行依赖<code>5.1</code>和<code>5.2</code>中的consul</p></blockquote>\n<h2 id=\"3-nginx相关\"><a href=\"#3-nginx相关\" class=\"headerlink\" title=\"3.nginx相关\"></a>3.nginx相关</h2><h3 id=\"3-1-安装\"><a href=\"#3-1-安装\" class=\"headerlink\" title=\"3.1 安装\"></a>3.1 安装</h3><h4 id=\"3-1-1-搜索镜像\"><a href=\"#3-1-1-搜索镜像\" class=\"headerlink\" title=\"3.1.1 搜索镜像\"></a>3.1.1 搜索镜像</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> search nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"3-1-2-拉取镜像\"><a href=\"#3-1-2-拉取镜像\" class=\"headerlink\" title=\"3.1.2 拉取镜像\"></a>3.1.2 拉取镜像</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> pull nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"3-1-3-运行镜像\"><a href=\"#3-1-3-运行镜像\" class=\"headerlink\" title=\"3.1.3 运行镜像\"></a>3.1.3 运行镜像</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">--name</span> nginx <span class=\"token parameter variable\">-p</span> <span class=\"token number\">80</span>:80 <span class=\"token parameter variable\">-d</span> nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"3-1-4-拷贝镜像配置文件\"><a href=\"#3-1-4-拷贝镜像配置文件\" class=\"headerlink\" title=\"3.1.4 拷贝镜像配置文件\"></a>3.1.4 拷贝镜像配置文件</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> <span class=\"token function\">cp</span> nginx:/etc/nginx/nginx.conf path/nginx<span class=\"token punctuation\">[</span>宿主机放配置文件路径<span class=\"token punctuation\">]</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"3-1-5-删除容器\"><a href=\"#3-1-5-删除容器\" class=\"headerlink\" title=\"3.1.5 删除容器\"></a>3.1.5 删除容器</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"3-1-6-指定配置文件运行镜像\"><a href=\"#3-1-6-指定配置文件运行镜像\" class=\"headerlink\" title=\"3.1.6 指定配置文件运行镜像\"></a>3.1.6 指定配置文件运行镜像</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">--name</span> nginx <span class=\"token parameter variable\">-p</span> <span class=\"token number\">80</span>:80 <span class=\"token parameter variable\">-v</span> <span class=\"token punctuation\">[</span>宿主机路径<span class=\"token punctuation\">]</span>/nginx/nginx.conf:/etc/nginx/nginx.conf:ro <span class=\"token parameter variable\">-v</span> <span class=\"token punctuation\">[</span>宿主机路径<span class=\"token punctuation\">]</span>/nginx/conf.d:/etc/nginx/conf.d <span class=\"token parameter variable\">-d</span> nginx<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"3-2-配置\"><a href=\"#3-2-配置\" class=\"headerlink\" title=\"3.2 配置\"></a>3.2 配置</h3><h4 id=\"3-2-1-配置负载均衡\"><a href=\"#3-2-1-配置负载均衡\" class=\"headerlink\" title=\"3.2.1 配置负载均衡\"></a>3.2.1 配置负载均衡</h4><p>在<code>[宿主机路径]/nginx/conf.d</code>目录下创建<code>load-balancer.conf</code>文件，内容如下：</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">upstream backend <span class=\"token punctuation\">&#123;</span>\n    server <span class=\"token number\">10.100</span>.40.243:8081<span class=\"token punctuation\">;</span>\n    server <span class=\"token number\">10.100</span>.40.243:8082<span class=\"token punctuation\">;</span>\n    server <span class=\"token number\">10.100</span>.40.243:8083<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n\nserver<span class=\"token punctuation\">&#123;</span>\n    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n\n    location / <span class=\"token punctuation\">&#123;</span>\n        proxy_pass http://backend<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"3-3-验证\"><a href=\"#3-3-验证\" class=\"headerlink\" title=\"3.3 验证\"></a>3.3 验证</h3><h4 id=\"3-3-1-重启nginx服务\"><a href=\"#3-3-1-重启nginx服务\" class=\"headerlink\" title=\"3.3.1 重启nginx服务\"></a>3.3.1 重启nginx服务</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">docker</span> <span class=\"token builtin class-name\">exec</span> <span class=\"token parameter variable\">-it</span> nginx nginx <span class=\"token parameter variable\">-s</span> reload<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"3-3-2-访问nginx服务\"><a href=\"#3-3-2-访问nginx服务\" class=\"headerlink\" title=\"3.3.2 访问nginx服务\"></a>3.3.2 访问nginx服务</h4><p>在浏览器中输入：<a href=\"http://localhost/index/nginx%EF%BC%8C%E5%A4%9A%E6%AC%A1%E8%AF%B7%E6%B1%82%E4%BE%9D%E6%AC%A1%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%88%B0%60openfeign\">http://localhost/index/nginx，多次请求依次可以看到`openfeign</a> service：hello nginx from 8081<code>、</code>openfeign service：hello nginx from 8082<code>、</code>openfeign service：hello nginx from 8083&#96;结果，则说明nginx负载均衡配置正常。</p>\n<h2 id=\"4-问题\"><a href=\"#4-问题\" class=\"headerlink\" title=\"4.问题\"></a>4.问题</h2><p>如你所见，服务的<code>负载均衡</code>能力是通过在<code>load-balancer.conf</code>配置文件中写死服务列表来实现的，同时也意味着，只要后端服务列表发生变化，就需要修改配置并通过<code>nginx -s reload</code>命令来重新加载。</p>\n<h2 id=\"5-方案\"><a href=\"#5-方案\" class=\"headerlink\" title=\"5.方案\"></a>5.方案</h2><p>有了问题，既然会有对应的解决方案，本文要介绍的解决方案就是<code>consul</code>和<code>consul template</code></p>\n<h3 id=\"5-1-安装consul\"><a href=\"#5-1-安装consul\" class=\"headerlink\" title=\"5.1 安装consul\"></a>5.1 安装consul</h3><p>根据<a href=\"https://learn.hashicorp.com/tutorials/consul/get-started-install?in=consul/getting-started\">Install Consul</a>官网教程安装consul</p>\n<h3 id=\"5-2-运行consul\"><a href=\"#5-2-运行consul\" class=\"headerlink\" title=\"5.2 运行consul\"></a>5.2 运行consul</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">consul agent <span class=\"token parameter variable\">-dev</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h3 id=\"5-3-安装consul-template\"><a href=\"#5-3-安装consul-template\" class=\"headerlink\" title=\"5.3 安装consul template\"></a>5.3 安装consul template</h3><h4 id=\"5-3-1-下载压缩包\"><a href=\"#5-3-1-下载压缩包\" class=\"headerlink\" title=\"5.3.1 下载压缩包\"></a>5.3.1 下载压缩包</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> https://releases.hashicorp.com/consul-template/0.20.0/consul-template_0.20.0_linux_amd64.zip<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<h4 id=\"5-3-2-解压\"><a href=\"#5-3-2-解压\" class=\"headerlink\" title=\"5.3.2 解压\"></a>5.3.2 解压</h4><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token function\">unzip</span> consul-template_0.20.0_linux_amd64.zip<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>Mac os可以通过<a href=\"https://formulae.brew.sh/formula/consul-template\">brew install consul-template</a>进行安装，简单、方便</p></blockquote>\n<h3 id=\"5-4-创建负载均衡配置文件模板\"><a href=\"#5-4-创建负载均衡配置文件模板\" class=\"headerlink\" title=\"5.4 创建负载均衡配置文件模板\"></a>5.4 创建负载均衡配置文件模板</h3><p>创建<code>load-balancer.ctmpl</code>文件，编辑如下内容：</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">upstream backend <span class=\"token punctuation\">&#123;</span>\n    <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span>- range <span class=\"token function\">service</span> <span class=\"token string\">\"openfeign-provider-service\"</span> <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span>\n        server <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span> .Address <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span> .Port <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#123;</span>- end <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\n\nserver <span class=\"token punctuation\">&#123;</span>\n   listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n\n   location / <span class=\"token punctuation\">&#123;</span>\n      proxy_pass http://backend<span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h3 id=\"5-5-清空配置文件\"><a href=\"#5-5-清空配置文件\" class=\"headerlink\" title=\"5.5 清空配置文件\"></a>5.5 清空配置文件</h3><p>清空<code>3.2.1</code>章节<code>load-balancer.conf</code>文件内容</p>\n<h3 id=\"5-6-创建consul-template配置\"><a href=\"#5-6-创建consul-template配置\" class=\"headerlink\" title=\"5.6 创建consul template配置\"></a>5.6 创建consul template配置</h3><p>创建<code>consul-template-config.hcl</code>文件，编辑如下内容：</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">consul <span class=\"token punctuation\">&#123;</span>\n  address <span class=\"token operator\">=</span> <span class=\"token string\">\"localhost:8500\"</span>\n\n  retry <span class=\"token punctuation\">&#123;</span>\n    enabled  <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    attempts <span class=\"token operator\">=</span> <span class=\"token number\">12</span>\n    backoff  <span class=\"token operator\">=</span> <span class=\"token string\">\"250ms\"</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span>\ntemplate <span class=\"token punctuation\">&#123;</span>\n  <span class=\"token builtin class-name\">source</span>      <span class=\"token operator\">=</span> <span class=\"token string\">\"[5.4章节指定的路径]/load-balancer.conf.ctmpl\"</span>\n  destination <span class=\"token operator\">=</span> <span class=\"token string\">\"[5.5章节指定的路径]/load-balancer.conf\"</span>\n  perms       <span class=\"token operator\">=</span> 0600\n  <span class=\"token builtin class-name\">command</span>     <span class=\"token operator\">=</span> <span class=\"token string\">\"sh -c docker exec -it nginx nginx -s reload\"</span>\n<span class=\"token punctuation\">&#125;</span>\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>address：指定consul地址；source：用于指定负载均衡配置模板文件路径；destination：负载均衡配置生成文件路径；command：用于指定要执行的命令。整体流程：consul template从<code>address</code>地址拉取服务地址列表，根据<code>source</code>模板文件生成负载均衡配置到<code>destination</code>文件中，执行<code>command</code>重新加载<code>nginx</code></p></blockquote>\n<h3 id=\"5-7-运行consul-template\"><a href=\"#5-7-运行consul-template\" class=\"headerlink\" title=\"5.7 运行consul template\"></a>5.7 运行consul template</h3><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">consul-template <span class=\"token parameter variable\">-config</span><span class=\"token operator\">=</span>consul-template-config.hcl<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span></span></code></pre>\n\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>运行<code>consul template</code>之后，会发现<code>load-balancer.conf</code>文件中有了<code>负载均衡</code>配置</p></blockquote>\n<h3 id=\"5-8-服务关闭、启动\"><a href=\"#5-8-服务关闭、启动\" class=\"headerlink\" title=\"5.8 服务关闭、启动\"></a>5.8 服务关闭、启动</h3><p>到这里，你会发现伴随着<code>服务关闭</code>、<code>服务启动</code>，<code>load-balancer.conf</code>配置文件中的内容也在一直跟着改变，从而实现<code>服务动态伸缩</code>。</p>\n","feature":true,"text":"1.前言如你所知，服务的常规部署方式如下： 对外暴露的服务都会在前面部署nginx用于提供反向代理和负载均衡能力 下面会快速部署一套类似的服务，分析其存在的问题并给出相应解决方案 2.应用相关2.1 启动服务使用boot-cloud-openfeign-provider启动3个服...","link":"","photos":[],"count_time":{"symbolsCount":"3k","symbolsTime":"3 mins."},"categories":[{"name":"微服务","slug":"微服务","count":3,"path":"api/categories/微服务.json"}],"tags":[{"name":"consul","slug":"consul","count":1,"path":"api/tags/consul.json"},{"name":"nginx","slug":"nginx","count":1,"path":"api/tags/nginx.json"},{"name":"consul-template","slug":"consul-template","count":1,"path":"api/tags/consul-template.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1-%E5%89%8D%E8%A8%80\"><span class=\"toc-text\">1.前言</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#2-%E5%BA%94%E7%94%A8%E7%9B%B8%E5%85%B3\"><span class=\"toc-text\">2.应用相关</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-1-%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1\"><span class=\"toc-text\">2.1 启动服务</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-2-%E6%9C%8D%E5%8A%A1%E9%AA%8C%E8%AF%81\"><span class=\"toc-text\">2.2 服务验证</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#3-nginx%E7%9B%B8%E5%85%B3\"><span class=\"toc-text\">3.nginx相关</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-1-%E5%AE%89%E8%A3%85\"><span class=\"toc-text\">3.1 安装</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3-1-1-%E6%90%9C%E7%B4%A2%E9%95%9C%E5%83%8F\"><span class=\"toc-text\">3.1.1 搜索镜像</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3-1-2-%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F\"><span class=\"toc-text\">3.1.2 拉取镜像</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3-1-3-%E8%BF%90%E8%A1%8C%E9%95%9C%E5%83%8F\"><span class=\"toc-text\">3.1.3 运行镜像</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3-1-4-%E6%8B%B7%E8%B4%9D%E9%95%9C%E5%83%8F%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6\"><span class=\"toc-text\">3.1.4 拷贝镜像配置文件</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3-1-5-%E5%88%A0%E9%99%A4%E5%AE%B9%E5%99%A8\"><span class=\"toc-text\">3.1.5 删除容器</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3-1-6-%E6%8C%87%E5%AE%9A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%BF%90%E8%A1%8C%E9%95%9C%E5%83%8F\"><span class=\"toc-text\">3.1.6 指定配置文件运行镜像</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-2-%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">3.2 配置</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3-2-1-%E9%85%8D%E7%BD%AE%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1\"><span class=\"toc-text\">3.2.1 配置负载均衡</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-3-%E9%AA%8C%E8%AF%81\"><span class=\"toc-text\">3.3 验证</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3-3-1-%E9%87%8D%E5%90%AFnginx%E6%9C%8D%E5%8A%A1\"><span class=\"toc-text\">3.3.1 重启nginx服务</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#3-3-2-%E8%AE%BF%E9%97%AEnginx%E6%9C%8D%E5%8A%A1\"><span class=\"toc-text\">3.3.2 访问nginx服务</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#4-%E9%97%AE%E9%A2%98\"><span class=\"toc-text\">4.问题</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#5-%E6%96%B9%E6%A1%88\"><span class=\"toc-text\">5.方案</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5-1-%E5%AE%89%E8%A3%85consul\"><span class=\"toc-text\">5.1 安装consul</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5-2-%E8%BF%90%E8%A1%8Cconsul\"><span class=\"toc-text\">5.2 运行consul</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5-3-%E5%AE%89%E8%A3%85consul-template\"><span class=\"toc-text\">5.3 安装consul template</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#5-3-1-%E4%B8%8B%E8%BD%BD%E5%8E%8B%E7%BC%A9%E5%8C%85\"><span class=\"toc-text\">5.3.1 下载压缩包</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#5-3-2-%E8%A7%A3%E5%8E%8B\"><span class=\"toc-text\">5.3.2 解压</span></a></li></ol></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5-4-%E5%88%9B%E5%BB%BA%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%A8%A1%E6%9D%BF\"><span class=\"toc-text\">5.4 创建负载均衡配置文件模板</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5-5-%E6%B8%85%E7%A9%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6\"><span class=\"toc-text\">5.5 清空配置文件</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5-6-%E5%88%9B%E5%BB%BAconsul-template%E9%85%8D%E7%BD%AE\"><span class=\"toc-text\">5.6 创建consul template配置</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5-7-%E8%BF%90%E8%A1%8Cconsul-template\"><span class=\"toc-text\">5.7 运行consul template</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#5-8-%E6%9C%8D%E5%8A%A1%E5%85%B3%E9%97%AD%E3%80%81%E5%90%AF%E5%8A%A8\"><span class=\"toc-text\">5.8 服务关闭、启动</span></a></li></ol></li></ol>","author":{"name":"黑白搬砖工","slug":"blog-author","avatar":"https://wolf-heart.oss-cn-beijing.aliyuncs.com/lg_22641_1606122876_5fbb7d7c432a1.jpeg","link":"/","description":"一位正在重塑知识的技术人","socials":{"github":"https://github.com/a601942905git","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/483440845930343","customs":{}}},"mapped":true,"prev_post":{"title":"Redis单机、主从、哨兵、集群演进之路","uid":"c301ef2215df3326fec1a274349ffccd","slug":"Redis单机、主从、哨兵、集群演进之路","date":"2023-01-04T01:49:00.000Z","updated":"2023-01-04T01:51:10.985Z","comments":true,"path":"api/articles/Redis单机、主从、哨兵、集群演进之路.json","keywords":null,"cover":[],"text":"1.前言1.1 单机时代刚接触redis的时候，为了能快速学习和了解这门技术，我们通常会在自己的电脑上部署一个redis服务，以此来开启redis学习之路 1.2 主从时代随着对redis的进一步深入，很快就会发现这门技术在很多场景下都能得到应用，比如：并发场景下对共享资源的控制...","link":"","photos":[],"count_time":{"symbolsCount":"8.3k","symbolsTime":"8 mins."},"categories":[{"name":"redis","slug":"redis","count":3,"path":"api/categories/redis.json"}],"tags":[{"name":"redis","slug":"redis","count":2,"path":"api/tags/redis.json"},{"name":"master-slave","slug":"master-slave","count":1,"path":"api/tags/master-slave.json"},{"name":"sentinel","slug":"sentinel","count":1,"path":"api/tags/sentinel.json"},{"name":"cluster","slug":"cluster","count":1,"path":"api/tags/cluster.json"}],"author":{"name":"黑白搬砖工","slug":"blog-author","avatar":"https://wolf-heart.oss-cn-beijing.aliyuncs.com/lg_22641_1606122876_5fbb7d7c432a1.jpeg","link":"/","description":"一位正在重塑知识的技术人","socials":{"github":"https://github.com/a601942905git","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/483440845930343","customs":{}}},"feature":true},"next_post":{"title":"一文读懂Redis持久化机制","uid":"077c9e1306e9e7f4038efb1171146e9a","slug":"一文读懂Redis持久化机制","date":"2022-12-18T07:32:00.000Z","updated":"2022-12-18T07:34:42.028Z","comments":true,"path":"api/articles/一文读懂Redis持久化机制.json","keywords":null,"cover":[],"text":"1.前言redis作为内存数据库，最常见的使用场景就是当缓存用。浏览器访问后端应用，后端应用先访问redis，如果redis中有数据，直接返回；否则就去查询数据库。 如你所知，redis作为内存数据库，数据存放在内存中，如果宕机，会导致数据全部丢失。数据丢失，来自浏览器的所有请求...","link":"","photos":[],"count_time":{"symbolsCount":"2.5k","symbolsTime":"2 mins."},"categories":[{"name":"redis","slug":"redis","count":3,"path":"api/categories/redis.json"}],"tags":[{"name":"redis","slug":"redis","count":2,"path":"api/tags/redis.json"},{"name":"aof","slug":"aof","count":1,"path":"api/tags/aof.json"},{"name":"rdb","slug":"rdb","count":1,"path":"api/tags/rdb.json"}],"author":{"name":"黑白搬砖工","slug":"blog-author","avatar":"https://wolf-heart.oss-cn-beijing.aliyuncs.com/lg_22641_1606122876_5fbb7d7c432a1.jpeg","link":"/","description":"一位正在重塑知识的技术人","socials":{"github":"https://github.com/a601942905git","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"https://juejin.cn/user/483440845930343","customs":{}}}}}